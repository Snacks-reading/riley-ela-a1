<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Riley Reads & Spells — Module A1</title>
<style>
  :root{ 
    --bg1:#060818; --bg2:#0b1635; --card:rgba(20,36,58,.60); --card2:rgba(10,16,28,.65);
    --stroke:rgba(255,255,255,.10); --stroke2:rgba(255,255,255,.14);
    --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.70); --muted2:rgba(255,255,255,.58);
    --aqua:#59e3ff; --mint:#53ffb7; --btn:rgba(30,70,92,.55); --btn2:rgba(45,95,125,.72);
    --warn:#ff4d7d;
    font-size: 15px;
  }
  @media (max-width: 1100px){ :root{ font-size: 14px; } }
  @media (max-width: 900px){ :root{ font-size: 13px; } }

  html,body{height:100%;}
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--text);
    background: radial-gradient(1200px 650px at 25% 20%, rgba(88,170,255,.30), transparent 60%),
                radial-gradient(900px 520px at 80% 25%, rgba(165,98,255,.22), transparent 60%),
                linear-gradient(180deg, var(--bg2), var(--bg1));
    overflow:hidden;
  }
  .wrap{height:100%; display:flex; flex-direction:column; padding:14px 14px 10px; box-sizing:border-box; gap:10px;}

  .topbar{
    display:grid;
    grid-template-columns: 1.1fr 1fr 1fr 1fr;
    align-items:center;
    gap:10px;
  }
  .brand h1{margin:0; font-size:2.2rem; letter-spacing:.5px;}
  .brand .sub{margin-top:2px; color:var(--muted); font-size:1.0rem;}

  .pills{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
  .pill{padding:10px 14px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--stroke); box-shadow: 0 10px 30px rgba(0,0,0,.35) inset; font-weight:700; color:var(--muted); white-space:nowrap;}
  .pill strong{color:var(--text)}

  .controls{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;}
  .btn{
    padding:12px 18px; border-radius:16px; border:1px solid var(--stroke2);
    background: linear-gradient(180deg, rgba(86,210,255,.18), rgba(20,50,70,.25));
    color:var(--text); font-weight:800; cursor:pointer; user-select:none;
    box-shadow: 0 16px 30px rgba(0,0,0,.45);
  }
  .btn:disabled{opacity:.45; cursor:not-allowed;}
  .btn.secondary{background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.12));}

  .midbar{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
    gap:10px;
    align-items:end;
  }
  .field{background:rgba(255,255,255,.05); border:1px solid var(--stroke); border-radius:18px; padding:10px 12px; box-shadow: inset 0 18px 30px rgba(0,0,0,.35);}
  .field label{display:block; font-size:.78rem; letter-spacing:1.6px; color:var(--muted2); text-transform:uppercase; margin-bottom:6px;}
  select{width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); color:var(--text); padding:10px 10px; font-weight:700; outline:none;}
  .rangeRow{display:flex; align-items:center; gap:10px;}
  input[type=range]{width:100%;}
  .tiny{font-size:.9rem; color:var(--muted); white-space:nowrap;}

  .grid{
    flex:1;
    display:grid;
    grid-template-columns: 1.18fr 1.05fr .77fr;
    gap:12px;
    min-height:0;
  }
  .card{background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.10)); border:1px solid var(--stroke); border-radius:22px; box-shadow: 0 22px 60px rgba(0,0,0,.55); overflow:hidden; min-height:0;}
  .cardInner{padding:14px 16px; height:100%; box-sizing:border-box; display:flex; flex-direction:column; gap:10px; min-height:0;}
  .h{font-size:1.15rem; letter-spacing:.6px; font-weight:900;}

  .teachBox{background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:12px; }
  .teachBox .focus{font-size:1.05rem; font-weight:900; color:var(--aqua)}
  .teachBox .focus span{color:var(--text)}
  .teachText{margin-top:10px; color:var(--text); line-height:1.25;}
  .teachMini{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
  .mini{background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:10px; min-height:90px;}
  .miniTitle{font-weight:900; letter-spacing:1.2px; color:var(--muted2); text-transform:uppercase; font-size:.78rem; margin-bottom:6px;}
  .mini ul{margin:0; padding-left:18px; color:var(--text); line-height:1.25;}

  .teacherSays{margin-top:auto; background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:10px; min-height:72px;}
  .teacherSays .label{font-size:.78rem; letter-spacing:1.2px; color:var(--muted2); text-transform:uppercase;}
  .teacherSays .line{margin-top:6px; font-size:1.02rem; line-height:1.25;}

  .practiceTop{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .practiceTitle{font-weight:900; font-size:1.18rem;}
  .practiceHint{color:var(--muted); font-weight:700;}
  .prompt{background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:12px; }
  .prompt .sentence{font-size:1.25rem; font-weight:900;}
  .prompt .sub{margin-top:6px; color:var(--muted); font-weight:700;}
  .answerRow{display:flex; gap:10px; align-items:center; margin-top:10px;}
  .answerRow input{flex:1; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.25); padding:14px 14px; color:var(--text); font-size:1.1rem; outline:none;}
  .checkBtn{padding:14px 18px; border-radius:16px; border:1px solid rgba(255,255,255,.16); background: linear-gradient(180deg, rgba(86,210,255,.18), rgba(20,50,70,.25)); color:var(--text); font-weight:900; cursor:pointer;}
  .checkBtn:disabled{opacity:.5; cursor:not-allowed;}

  .feedback{margin-top:10px; border-radius:16px; padding:10px 12px; border:1px dashed rgba(255,77,125,.55); background:rgba(255,77,125,.08); color:var(--text); font-weight:800; min-height:48px; display:flex; align-items:center;}
  .feedback.good{border-color: rgba(83,255,183,.55); background:rgba(83,255,183,.08);}

  .stats{margin-top:auto; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
  .stat{background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:10px;}
  .stat .k{font-size:.78rem; letter-spacing:1.2px; color:var(--muted2); text-transform:uppercase;}
  .stat .v{margin-top:6px; font-size:1.25rem; font-weight:900;}

  .avatar{display:flex; flex-direction:column; height:100%;}
  .avatarHead{display:flex; align-items:center; justify-content:space-between;}
  .avatarHead .name{font-size:1.1rem; font-weight:900;}
  .avatarHead .tries{color:var(--muted); font-weight:800;}
  .avatarBox{flex:1; border-radius:22px; border:1px solid rgba(255,255,255,.10);
             background: radial-gradient(600px 420px at 50% 30%, rgba(88,170,255,.20), transparent 60%), rgba(0,0,0,.16);
             display:flex; align-items:flex-end; justify-content:center; overflow:hidden; margin-top:10px; padding:10px; box-sizing:border-box;}
  /* Keep Riley's head visible: fit whole image, bias toward top */
  .avatarBox img{max-width:100%; max-height:100%; width:100%; height:100%; object-fit:contain; object-position:center top; filter: drop-shadow(0 26px 40px rgba(0,0,0,.55));}
  .avatarStats{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}

  .footer{display:flex; justify-content:space-between; color:var(--muted2); font-size:.9rem; padding:0 2px;}

  /* Keep everything visible at 100% on common laptops */
  @media (max-height: 760px){
    .wrap{padding:12px 12px 8px; gap:8px;}
    .cardInner{padding:12px 14px; gap:8px;}
    .teacherSays{min-height:64px;}
    .mini{min-height:86px;}
  }
  @media (max-height: 700px){
    :root{font-size: 13.5px;}
    .brand h1{font-size:2.0rem;}
    .prompt .sentence{font-size:1.15rem;}
    .avatarBox img{width:min(100%, 380px);}
  }

#fxCanvas{position:fixed;inset:0;pointer-events:none;z-index:999;display:none;}

</style>
</head>
<body>
  <canvas id="fxCanvas" aria-hidden="true"></canvas>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <h1>Riley Reads &amp; Spells</h1>
      <div class="sub">Lesson A1 — Guard the Vowel (CVC Doubling)</div>
    </div>

    <div class="pills">
      <div class="pill">Stage: <strong id="stagePill">Intro</strong></div>
      <div class="pill">Mastery: <strong id="masteryPill">0%</strong></div>
      <div class="pill">Course: <strong>Module A — Word Study</strong></div>
    </div>

    <div></div>

    <div class="controls">
      <button class="btn" id="playBtn">Play</button>
      <button class="btn secondary" id="repeatBtn">Repeat</button>
      <button class="btn secondary" id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="midbar">
    <div class="field">
      <label>Skill / Lesson</label>
      <select id="lessonSel">
        <option value="cvc">Doubling Consonants (CVC) — Guard the Vowel</option>
      </select>
    </div>
    <div class="field">
      <label>Mode</label>
      <select id="modeSel">
        <option value="type">Spell It (Typing)</option>
      </select>
    </div>
    <div class="field">
      <label>Voice</label>
      <select id="voiceSel"></select>
    </div>
    <div class="field">
      <label>Speed</label>
      <div class="rangeRow">
        <input id="speed" type="range" min="0.85" max="1.1" step="0.01" value="0.98" />
        <span class="tiny" id="speedLbl">0.98×</span>
      </div>
    </div>
    <div class="field">
      <label>Sound</label>
      <select id="soundSel">
        <option value="on" selected>On</option>
        <option value="off">Off</option>
      </select>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="cardInner">
        <div class="h">TEACHING</div>
        <div class="teachBox">
          <div class="focus">Today’s Focus: <span>Guard a short vowel when you add a vowel suffix.</span></div>
          <div class="teachText" id="ruleText">
            <strong>CVC Doubling Rule:</strong> If a base word ends with <strong>C‑V‑C</strong>, double the final consonant before adding a vowel suffix (<strong>-ing, -ed, -er, -est, -y</strong>). Doubling keeps the vowel short (hopping vs. hoping).
          </div>
          <div class="teachMini">
            <div class="mini">
              <div class="miniTitle">Examples</div>
              <ul>
                <li>run → running</li>
                <li>sit → sitter</li>
                <li>stop → stopped</li>
                <li>big → biggest</li>
              </ul>
            </div>
            <div class="mini">
              <div class="miniTitle">When NOT to double</div>
              <ul>
                <li>Suffix starts with a consonant: sad + ness</li>
                <li>Two vowels: read + ing</li>
                <li>Ends with two consonants: jump + ing</li>
                <li>Ends in w/x/y: snow + ing</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="teacherSays" aria-live="polite">
          <div class="label">Teacher says</div>
          <div class="line" id="teacherLine">Press <strong>Play</strong> to start the lesson.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardInner">
        <div class="practiceTop">
          <div class="practiceTitle">PRACTICE</div>
          <div class="practiceHint">Type your answer, then press Check.</div>
        </div>

        <div showing id="practiceBox" class="prompt">
          <div class="sentence" id="sentenceLine">Press <strong>Play</strong> to begin teaching. Practice starts after the lesson.</div>
          <div class="sub" id="subLine">You will hear a sentence and a word. Type the missing word.</div>
          <div class="answerRow">
            <input id="answer" placeholder="Type the missing word" autocomplete="off" autocapitalize="none" spellcheck="false" disabled />
            <button class="checkBtn" id="checkBtn" disabled>Check</button>
          </div>
          <div id="feedback" class="feedback" style="display:none"></div>
        </div>

        <div class="stats">
          <div class="stat"><div class="k">Correct</div><div class="v" id="correct">0</div></div>
          <div class="stat"><div class="k">Attempts</div><div class="v" id="attempts">0</div></div>
          <div class="stat"><div class="k">Streak</div><div class="v" id="streak">0</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardInner avatar">
        <div class="avatarHead">
          <div class="name">RILEY</div>
          <div class="tries">Tries: <span id="tries">0</span></div>
        </div>
        <div class="avatarBox">
          <img id="rileyImg" alt="Riley" src="riley-avatar.png" />
        </div>
        <div class="avatarStats">
          <div class="stat"><div class="k">XP</div><div class="v" id="xp">0</div></div>
          <div class="stat"><div class="k">Accuracy</div><div class="v" id="accuracy">0%</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>v1.20 — single-file • Teaching is paced (no racing) • Repeat repeats last audio</div>
    <div>Best results: Safari / Chrome / Edge</div>
  </div>
</div>

<script>

(() => {
  const LESSON_LINES = ["Hey Riley! Today we’re learning a super useful spelling rule.", "It’s called the CVC Doubling Rule — we use it to guard a short vowel.", "CVC means: consonant, vowel, consonant. Like r-u-n… run.", "Here’s the big idea: when a vowel suffix tries to sneak in — like -ing, -ed, -er, -est, or -y — it can make the vowel sound long.", "Example: hope plus ing becomes hoping. The o changes to a long o.", "But with a short vowel word like hop, we want the o to stay short.", "So we double the last consonant to lock the vowel in: hop plus ing becomes hopping.", "Let’s say the checklist together.", "One: is it one syllable? Two: does it have one short vowel? Three: does it end in one consonant? Four: does the suffix start with a vowel?", "If yes to all four… double the final consonant!", "Examples: run to running. sit to sitter. stop to stopped. big to biggest.", "Now when do we NOT double?", "If the suffix starts with a consonant — like sad plus ness. No doubling.", "If the base word has two vowels — like read plus ing. No doubling.", "If the base word ends with two consonants — like jump plus ing. No doubling.", "And we never double w, x, or y.", "Alright — lesson complete. Now we practice with sentences!"];
  const PRACTICE = [{"word": "running", "sentence": "Every morning, I am __ around the block."}, {"word": "hopping", "sentence": "The bunny is __ over a log."}, {"word": "sitting", "sentence": "I am __ at my desk doing homework."}, {"word": "stopped", "sentence": "The rain __, and the sun came out."}, {"word": "biggest", "sentence": "That was the __ snowman on the hill."}, {"word": "swimmer", "sentence": "My cousin is a fast __."}, {"word": "funnier", "sentence": "That joke was even __ the second time."}, {"word": "sunniest", "sentence": "Saturday was the __ day this week."}, {"word": "clapping", "sentence": "The crowd started __ for the band."}, {"word": "skipped", "sentence": "We __ rocks across the lake."}, {"word": "grinning", "sentence": "Riley was __ when she heard the good news."}, {"word": "dropped", "sentence": "I __ my pencil, so I picked it up."}, {"word": "hugging", "sentence": "The little girl was __ her puppy."}, {"word": "planning", "sentence": "We are __ a fun day at the park."}, {"word": "trimming", "sentence": "Dad is __ the hedge in the yard."}, {"word": "drumming", "sentence": "He was __ on the table with his fingers."}, {"word": "slipped", "sentence": "My shoe __ on the wet floor."}, {"word": "shipping", "sentence": "The store is __ the package today."}, {"word": "bigger", "sentence": "This puzzle is __ than the last one."}, {"word": "happy", "sentence": "Riley felt __ after the surprise."}, {"word": "saddest", "sentence": "That was the __ scene in the movie."}, {"word": "robbed", "sentence": "The thief __ the bank in the story."}, {"word": "jogging", "sentence": "My aunt goes __ after dinner."}, {"word": "spitting", "sentence": "The baby was __ out her carrots."}, {"word": "sipped", "sentence": "She __ her hot cocoa slowly."}, {"word": "hottest", "sentence": "July is usually the __ month."}, {"word": "fatter", "sentence": "The bear looked __ before winter."}, {"word": "muddier", "sentence": "The trail got __ after the storm."}, {"word": "foggy", "sentence": "The morning was __ near the river."}, {"word": "sunny", "sentence": "The beach day was __ and bright."}];

  // UI
  const stagePill = document.getElementById('stagePill');
  const masteryPill = document.getElementById('masteryPill');
  const teacherLine = document.getElementById('teacherLine');
  const sentenceLine = document.getElementById('sentenceLine');
  const subLine = document.getElementById('subLine');
  const answer = document.getElementById('answer');
  const checkBtn = document.getElementById('checkBtn');
  const feedback = document.getElementById('feedback');

  const playBtn = document.getElementById('playBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const resetBtn = document.getElementById('resetBtn');

  const voiceSel = document.getElementById('voiceSel');
  const speed = document.getElementById('speed');
  const speedLbl = document.getElementById('speedLbl');
  const soundSel = document.getElementById('soundSel');

  const correctEl = document.getElementById('correct');
  const attemptsEl = document.getElementById('attempts');
  const streakEl = document.getElementById('streak');
  const triesEl = document.getElementById('tries');
  const xpEl = document.getElementById('xp');
  const accuracyEl = document.getElementById('accuracy');

  // State
  const state = {
    mode: 'idle', // idle | teaching | practice
    lessonIdx: 0,
    practiceIdx: 0,
    lastSpokenText: '',
    speaking: false,
    cancelled: false,
    correct: 0,
    attempts: 0,
    streak: 0,
    tries: 0,
    xp: 0,
    currentWord: null,
    currentSentence: null,
    missesOnCurrent: 0,
    speechToken: 0,
    // practice flow
    queue: [],
    recycle: [],
  };

  // --- Poses + celebration FX ---
  const POSES = {
    neutral: 'riley-avatar.png',
    celebrate: 'pose_celebrate.png',
    sad: 'pose_sad.png',
  };
  const rileyImg = document.getElementById('rileyImg');
  let poseTimer = null;
  function setPose(key, ms=0){
    if(!rileyImg) return;
    if(poseTimer){ clearTimeout(poseTimer); poseTimer=null; }
    rileyImg.src = POSES[key] || POSES.neutral;
    if(ms>0){
      poseTimer = setTimeout(()=>{ rileyImg.src = POSES.neutral; }, ms);
    }
  }

  // Simple fireworks burst on a full-screen canvas
  const fxCanvas = document.getElementById('fxCanvas');
  const fxCtx = fxCanvas ? fxCanvas.getContext('2d') : null;
  function resizeFx(){
    if(!fxCanvas) return;
    const dpr = (window.devicePixelRatio||1);
    fxCanvas.width = Math.floor(window.innerWidth * dpr);
    fxCanvas.height = Math.floor(window.innerHeight * dpr);
    fxCanvas.style.width = window.innerWidth + 'px';
    fxCanvas.style.height = window.innerHeight + 'px';
    if(fxCtx) fxCtx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resizeFx);
  resizeFx();
  function fireworksBurst(durationMs=1200){
    if(!fxCanvas || !fxCtx) return;
    fxCanvas.style.display = 'block';
    // Ensure particles are visible on the dark UI
    fxCtx.fillStyle = 'rgba(140, 230, 255, 1)';
    const start = performance.now();
    const particles = [];
    const cx = window.innerWidth * 0.5;
    const cy = window.innerHeight * 0.25;
    const n = 70;
    for(let i=0;i<n;i++){
      const a = (Math.PI*2*i)/n;
      const sp = 2.5 + Math.random()*4.0;
      particles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:0});
    }
    function tick(t){
      const dt = 16;
      fxCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
      for(const p of particles){
        p.life += dt;
        p.vy += 0.05;
        p.x += p.vx;
        p.y += p.vy;
        const alpha = Math.max(0, 1 - (t-start)/durationMs);
        fxCtx.globalAlpha = alpha;
        fxCtx.beginPath();
        fxCtx.arc(p.x,p.y,2.2,0,Math.PI*2);
        fxCtx.fill();
      }
      fxCtx.globalAlpha = 1;
      if(t-start < durationMs){ requestAnimationFrame(tick); }
      else{ fxCtx.clearRect(0,0,window.innerWidth,window.innerHeight); fxCanvas.style.display='none'; }
    }
    requestAnimationFrame(tick);
  }

  // Alias used by the scoring flow
  function burstFireworks(durationMs=1200){
    fireworksBurst(durationMs);
  }

  function setStage(s){ stagePill.textContent = s; }

  function updateStats(){
    correctEl.textContent = String(state.correct);
    attemptsEl.textContent = String(state.attempts);
    streakEl.textContent = String(state.streak);
    triesEl.textContent = String(state.tries);
    xpEl.textContent = String(state.xp);
    const acc = state.attempts ? Math.round((state.correct/state.attempts)*100) : 0;
    masteryPill.textContent = acc + '%';
    accuracyEl.textContent = acc + '%';
  }

  // ---------- Speech (robust queue) ----------
  function soundOn(){ return soundSel.value === 'on'; }
  function rate(){ return Number(speed.value) || 0.98; }

  function getSelectedVoice(){
    const voices = speechSynthesis.getVoices();
    const vId = voiceSel.value;
    return voices.find(v => v.voiceURI === vId) || voices.find(v => v.name === vId) || null;
  }

  function speak(text, {token=null, interrupt=false} = {}){
    // Speech queue control: interrupt cancels any current/pending speech and bumps the token.
    if(interrupt){
      state.speechToken = (state.speechToken||0) + 1;
      try{ speechSynthesis.cancel(); }catch(e){}
    }
    const myToken = token ?? (state.speechToken||0);
    state.lastSpokenText = text;
    if(!soundOn()) return Promise.resolve();

    return new Promise((resolve)=>{
      try{
        const u = new SpeechSynthesisUtterance(String(text||''));
        u.rate = Math.max(0.6, Math.min(1.25, Number(speed.value)||1));
        const v = getSelectedVoice();
        if(v) u.voice = v;
        u.onend = ()=> resolve();
        u.onerror = ()=> resolve();
        speechSynthesis.speak(u);
      }catch(e){
        resolve();
      }
    });
  }

  function wait(ms){ return new Promise(r => setTimeout(r, ms)); }

  // ---------- Voices list ----------
  function buildVoiceList(){
    const voices = speechSynthesis.getVoices().filter(v => (v.lang||'').toLowerCase().startsWith('en-us'));
    voiceSel.innerHTML = '';

    const pref = [
      v => /google us english/i.test(v.name),
      v => /samantha/i.test(v.name),
      v => /ava/i.test(v.name),
      v => /alloy|verse|nova/i.test(v.name),
    ];

    const sorted = voices.slice().sort((a,b)=>{
      const score = (v)=>{
        let s=0;
        pref.forEach((fn,i)=>{ if(fn(v)) s += (10-i); });
        if(/microsoft/i.test(v.name)) s -= 2;
        return -s;
      };
      return score(a) - score(b);
    });

    for(const v of sorted){
      const opt = document.createElement('option');
      opt.value = v.voiceURI;
      opt.textContent = v.name + ' (' + v.lang + ')';
      voiceSel.appendChild(opt);
    }

    // default
    const best = sorted.find(v => /google us english/i.test(v.name)) || sorted[0];
    if(best) voiceSel.value = best.voiceURI;
  }

  // Safari needs a tick to populate voices
  function initVoices(){
    buildVoiceList();
    if(!voiceSel.options.length){
      setTimeout(buildVoiceList, 250);
      setTimeout(buildVoiceList, 650);
    }
  }

  // ---------- Lesson flow ----------
  async function runTeaching(){
    state.mode = 'teaching';
    // Interrupt any prior speech once, then speak the lesson smoothly without cancelling mid-line.
    state.speechToken = (state.speechToken||0) + 1;
    const tok = state.speechToken;
    try{ speechSynthesis.cancel(); }catch(e){}
    setStage('Teaching');
    answer.disabled = true;
    checkBtn.disabled = true;
    feedback.style.display='none';

    for(; state.lessonIdx < LESSON_LINES.length; state.lessonIdx++){
      if(state.cancelled) return;
      const line = LESSON_LINES[state.lessonIdx];
      teacherLine.textContent = line;
      sentenceLine.textContent = 'Teaching… listen to the lesson. Practice starts after teaching.';
      subLine.textContent = 'Tip: Press Repeat to hear the last line again.';
      await speak(line, {token: tok});
      await wait(250);
    }

    // Transition
    teacherLine.textContent = 'Great job. Now it’s your turn — practice time!';
    await speak('Great job. Now it’s your turn — practice time!', {token: tok});
    await wait(200);

    await startPractice();
  }

  function shuffleInPlace(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function refillQueue(){
    // Only recycle words Riley missed (after 3 tries). If nothing missed, reshuffle full bank.
    if(state.queue.length===0){
      if(state.recycle.length>0){
        state.queue = shuffleInPlace(state.recycle.slice());
        state.recycle = [];
      } else {
        state.queue = shuffleInPlace(PRACTICE.slice());
      }
    }
  }

  function choosePracticeItem(){
    refillQueue();
    const item = state.queue.shift();
    state.currentItem = item;
    state.currentWord = item.word;
    state.currentSentence = item.sentence;
    state.missesOnCurrent = 0;
    sentenceLine.textContent = 'Sentence: ' + item.sentence;
    subLine.textContent = 'Listen: sentence first, then the word. Type the missing word.';
    answer.value = '';
    answer.focus();
    feedback.style.display='none';
  }

  async function speakPracticePrompt(){
    // Interrupt any previous prompt so we never race or overlap speech.
    state.speechToken = (state.speechToken||0) + 1;
    const tok = state.speechToken;
    try{ speechSynthesis.cancel(); }catch(e){}

    const sent = state.currentSentence;
    const word = state.currentWord;
    // Speak sentence with a pause, then the target word.
    await speak('Sentence. ' + String(sent||'').replace('__','blank'), {token: tok});
    await wait(280);
    await speak('Word. ' + String(word||'') + '.', {token: tok});
  }

  async function startPractice(){
    state.mode = 'practice';
    setStage('Guided');
    answer.disabled = false;
    checkBtn.disabled = false;
    state.queue = [];
    state.recycle = [];
    choosePracticeItem();
    // Auto-read prompt once when practice begins
    await speakPracticePrompt();
  }

  async function handlePlay(){
    state.cancelled = false;

    if(state.mode === 'idle'){
      state.lessonIdx = 0;
      teacherLine.textContent = 'Starting lesson…';
      await wait(50);
      await runTeaching();
      return;
    }

    if(state.mode === 'teaching'){
      // replay current line (don't skip ahead)
      state.speechToken++;
      const tok = state.speechToken;
      try{ speechSynthesis.cancel(); }catch(e){}
      const idx = Math.min(state.lessonIdx, LESSON_LINES.length-1);
      const line = LESSON_LINES[idx] || 'Teaching in progress.';
      teacherLine.textContent = line;
      await speak(line, {token: tok});
      return;
    }

    if(state.mode === 'practice'){
      await speakPracticePrompt();
    }
  }

  async function handleRepeat(){
    if(state.lastSpokenText){
      await speak(state.lastSpokenText, {interrupt:true});
    } else if(state.mode === 'practice'){
      await speakPracticePrompt();
    } else {
      await speak('Press Play to start.');
    }
  }

  function showFeedback(ok, msg){
    feedback.style.display='flex';
    feedback.classList.toggle('good', ok);
    feedback.textContent = String(msg ?? '');
  }

  function showFeedbackHTML(ok, html){
    feedback.style.display='flex';
    feedback.classList.toggle('good', ok);
    feedback.innerHTML = html;
  }

  async function speakSpelling(word, token){
    // Speak the word, then spell it out loud letter-by-letter.
    const w = String(word||'').trim();
    if(!w) return;
    await speak(`The correct spelling is ${w}.`, { token });
    await wait(120);
    const letters = w.toUpperCase().split('').join(' ');
    await speak(`Spell it: ${letters}.`, { token });
  }

  async function nextItem(){
    choosePracticeItem();
    await wait(120);
    await speakPracticePrompt();
  }

  async function check(){
    if(state.mode !== 'practice') return;

    const got = (answer.value||'').trim().toLowerCase();
    const want = (state.currentWord||'').trim().toLowerCase();
    if(!got) return;

    state.attempts++;
    state.tries++;

    // Stop any ongoing sentence/word prompt so feedback coaching doesn't get cut off.
    state.speechToken = (state.speechToken||0) + 1;
    const tok = state.speechToken;
    try{ speechSynthesis.cancel(); }catch(e){}

    if(got === want){
      state.correct++;
      state.streak++;
      state.xp += 10;
      updateStats();
      showFeedback(true, 'Correct!');
      // celebrate (brief)
      setPose('celebrate', 1200);
      burstFireworks(1200);
      await speak('Correct! Nice work.', {token: tok});
      await wait(250);
      await nextItem();
      return;
    }

    // incorrect
    setPose('sad', 900);
    state.streak = 0;
    state.missesOnCurrent++;
    updateStats();

    if(state.missesOnCurrent < 3){
      showFeedback(false, 'Try again. Say the base word in your head. Is the vowel short?');
      await speak("Not yet. Say the base word. If the vowel sounds short and it's C-V-C, you usually double the last consonant before the ending. Try again.", {token: tok});
      // Do not repeat the sentence after an incorrect response — let her try again.
      return;
    }
    // 3 misses: SHORT coach + reveal correct spelling (shown + spoken + spelled) then advance.
    if(state.currentItem) state.recycle.push(state.currentItem);
    const correct = want;
    const shortCoach = [
      "Let's lock the vowel.",
      "If the word ends C V C and the ending starts with a vowel, we double the last consonant.",
      "Watch: the extra vowel would try to change the short vowel — like hoping versus hopping."
    ];

    // Keep the on-screen coaching compact.
    showFeedbackHTML(false, `Let's lock the vowel. <span style="margin-left:.35em"><strong>Correct spelling:</strong> <span style="letter-spacing:.02em">${correct}</span></span>`);

    // Speak the coaching in a natural, short sequence.
    for(const line of shortCoach){
      await speak(line, {token: tok});
      await wait(160);
    }

    // Say + spell the correct word before advancing.
    await speak('Correct spelling is ' + correct + '.', {token: tok});
    await wait(120);
    await speak('Spell it: ' + String(correct).split('').join(' ') + '.', {token: tok});
    await wait(250);

    await nextItem();

  }

  function resetAll(){
    state.cancelled = true;
    try{ speechSynthesis.cancel(); }catch(e){}

    state.mode = 'idle';
    state.lessonIdx = 0;
    state.practiceIdx = 0;
    state.lastSpokenText = '';
    state.correct = 0;
    state.attempts = 0;
    state.streak = 0;
    state.tries = 0;
    state.xp = 0;
    state.currentWord = null;
    state.currentSentence = null;
    state.missesOnCurrent = 0;

    setStage('Intro');
    teacherLine.innerHTML = 'Press <strong>Play</strong> to start the lesson.';
    sentenceLine.innerHTML = 'Press <strong>Play</strong> to begin teaching. Practice starts after the lesson.';
    subLine.textContent = 'You will hear a sentence and a word. Type the missing word.';
    answer.value = '';
    answer.disabled = true;
    checkBtn.disabled = true;
    feedback.style.display='none';
    updateStats();
  }

  // Events
  playBtn.addEventListener('click', () => { handlePlay(); });
  repeatBtn.addEventListener('click', () => { handleRepeat(); });
  resetBtn.addEventListener('click', () => { resetAll(); });

  checkBtn.addEventListener('click', () => { check(); });
  answer.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ e.preventDefault(); check(); } });

  speed.addEventListener('input', ()=>{ speedLbl.textContent = (Number(speed.value)).toFixed(2) + '×'; });
  soundSel.addEventListener('change', ()=>{ if(!soundOn()) { try{ speechSynthesis.cancel(); }catch(e){} } });

  // init
  initVoices();
  if('speechSynthesis' in window){
    window.speechSynthesis.onvoiceschanged = () => buildVoiceList();
  }
  updateStats();
  resetAll();

})();

</script>
</body>
</html>
